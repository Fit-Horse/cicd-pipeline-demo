# ============================================
# GitHub Actions CI/CD 工作流
# 自动化构建、测试和部署流程
# 支持自动推送到 Docker Hub
# ============================================

name: CI/CD Pipeline

# 触发条件
on:
  # 推送到 main 分支时触发
  push:
    branches: [main]
    # 当推送 tags 时也触发 (用于版本发布)
    tags:
      - 'v*'
  # 推送到 PR 时触发
  pull_request:
    branches: [main]

# 环境变量
env:
  # Docker 镜像名称 (需要修改为你的 Docker Hub 用户名)
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/cicd-pipeline-demo
  # Node.js 版本
  NODE_VERSION: '18'

# 定义任务
jobs:
  # ============================================
  # 任务 1: 持续集成 (CI)
  # 安装依赖并运行测试
  # ============================================
  ci:
    name: 持续集成 (CI)
    # 运行在 Ubuntu 最新版系统
    runs-on: ubuntu-latest

    # 步骤列表
    steps:
      # 步骤 1: 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 步骤 2: 设置 Node.js 环境
      - name: 设置 Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 步骤 3: 安装依赖
      - name: 安装依赖
        run: npm install

      # 步骤 4: 运行测试
      - name: 运行测试
        run: npm test

      # 步骤 5: 上传测试覆盖率报告
      - name: 上传测试覆盖率报告
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-report
          path: coverage/
          retention-days: 7

  # ============================================
  # 任务 2: 持续交付 (CD) - Docker 镜像构建并推送到 Docker Hub
  # 仅在 CI 任务成功后执行
  # ============================================
  build-and-push:
    name: 构建并推送 Docker 镜像
    # 依赖 CI 任务，只有 CI 成功才执行
    needs: ci
    runs-on: ubuntu-latest
    # 仅在推送到 main 分支时执行 (PR 和 tag 推送也触发)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      # 步骤 1: 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 步骤 2: 登录 Docker Hub
      # 使用 GitHub Secrets 中存储的凭证
      - name: 登录 Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 步骤 4: 提取元数据 (版本号等)
      - name: 提取 Docker 元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          # 生成多种标签
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=
          # 自定义标签
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_NAME }}
            org.opencontainers.image.description=CI/CD Pipeline Demo
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.vendor=GitHub Actions

      # 步骤 5: 构建并推送 Docker 镜像
      - name: 构建并推送 Docker 镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          # 推送到 Docker Hub
          push: true
          # 多平台：amd64（服务器/Intel）+ arm64（Apple Silicon M1/M2/M3）
          platforms: linux/amd64,linux/arm64
          # 生成的所有标签
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # 步骤 6: 输出镜像信息
      - name: 显示镜像信息
        run: |
          echo "✅ Docker 镜像构建并推送成功!"
          echo "镜像地址: ${{ env.IMAGE_NAME }}"
          echo "标签: ${{ steps.meta.outputs.tags }}"

      # 步骤 7: 创建 GitHub Release (仅当推送 tag 时)
      - name: 创建 GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

  # ============================================
  # 任务 3: 通知部署完成 (可选)
  # ============================================
  notify:
    name: 部署通知
    needs: build-and-push
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: 检查构建状态
        run: |
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "✅ CI/CD 流程完成 - 镜像已推送到 Docker Hub"
          else
            echo "❌ CI/CD 流程失败"
            exit 1
          fi
